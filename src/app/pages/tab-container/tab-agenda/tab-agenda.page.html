<ion-header>
  <ion-toolbar color="primary" mode="md">
    <ion-buttons 
        slot="secondary">
      <ion-button 
          *ngIf="selectedView == 'personal'"
          (click)="onClickGoToPersonalHistoryList()"
          color="success">
        Storico
        <ion-icon slot="end" name="calendar-number-outline"></ion-icon>
      </ion-button>    

      <ion-button 
          *ngIf="selectedView != 'personal'"
          (click)="goToListCustomer()"
          color="success">
        Clienti
        <ion-icon slot="end" name="people-outline"></ion-icon>
      </ion-button>      
    </ion-buttons>
        
    <ion-title>
      {{selectedArea ? selectedArea.DENOMINAZIONE : 'Agenda'}}
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-grid
      class="ion-margin-bottom"
      >
    <ion-row>
      <ion-col sizeXs="12" 
               sizeSm="12" 
               sizeMd="12" 
               sizeLg="8" offsetLg="2"
               sizeXl="6" offsetXl="3">

          <ion-segment
              *ngIf="showSegmentTop" 
              mode="md"
              [(ngModel)] = "selectedView"
              (ionChange) = "onChangeSegmentTop($event)"
              >

            <ion-segment-button value="personal">
              <ion-label>Personali</ion-label>
              <ion-icon name="person-circle-outline"></ion-icon>
            </ion-segment-button>

            <ion-segment-button 
                    *ngIf="showTrainer"
                    value="trainer">
              <ion-label>Trainer</ion-label>
              <ion-icon name="barbell-outline"></ion-icon>
            </ion-segment-button>

            <ion-segment-button 
                    *ngIf="showCustode"
                    value="custode">
              <ion-label>Custode</ion-label>
              <ion-icon name="man-outline"></ion-icon>
            </ion-segment-button>
          </ion-segment>



<!-- SEGMENTO PERSONALE -->
<div *ngIf="selectedView == 'personal'" class="personal-view">

  <!-- QUICK STATS ROW -->
  <div class="stats-row">
    <div class="stat-card">
      <ion-icon name="calendar-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ getTotalImpegniMese() }}</span>
        <span class="stat-label">Questo mese</span>
      </div>
    </div>

    <div class="stat-card">
      <ion-icon name="time-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ getNextDays() }}</span>
        <span class="stat-label">Prossimi gg</span>
      </div>
    </div>

    <div class="stat-card active">
      <ion-icon name="checkmark-circle-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ listImpegni?.length || 0 }}</span>
        <span class="stat-label">In agenda</span>
      </div>
    </div>
  </div>

  <!-- FILTRI QUICK -->
  <div class="quick-filters">
    <ion-chip 
      [class.active]="personalFilter === 'tutti'"
      (click)="onChangePersonalFilter('tutti')">
      <ion-icon name="list-outline"></ion-icon>
      <ion-label>Tutti</ion-label>
    </ion-chip>

    <ion-chip 
      [class.active]="personalFilter === 'oggi'"
      (click)="onChangePersonalFilter('oggi')">
      <ion-icon name="today-outline"></ion-icon>
      <ion-label>Oggi</ion-label>
    </ion-chip>

    <ion-chip 
      [class.active]="personalFilter === 'domani'"
      (click)="onChangePersonalFilter('domani')">
      <ion-icon name="calendar-clear-outline"></ion-icon>
      <ion-label>Domani</ion-label>
    </ion-chip>

    <ion-chip 
      [class.active]="personalFilter === 'settimana'"
      (click)="onChangePersonalFilter('settimana')">
      <ion-icon name="calendar-number-outline"></ion-icon>
      <ion-label>Settimana</ion-label>
    </ion-chip>
  </div>

  <!-- PROSSIMO IMPEGNO CON COUNTDOWN -->
  <div class="next-impegno-section" *ngIf="nextImpegno">
    <div class="section-header">
      <h3>
        <ion-icon name="flash"></ion-icon>
        Prossimo Impegno
      </h3>
    </div>

    <div class="countdown-card" (click)="onClickImpegnoPersonale(nextImpegno)">
      <!-- Countdown Timer -->
      <div class="countdown-header">
        <div class="countdown-timer">
          <ion-icon name="time-outline" class="timer-icon"></ion-icon>
          <div class="timer-text">
            <span class="timer-value">{{ getCountdown(nextImpegno) }}</span>
            <span class="timer-label">Inizia tra</span>
          </div>
        </div>
        <ion-badge [color]="getImpegnoColor(nextImpegno)">
          {{ getCampoImpegno(nextImpegno) }}
        </ion-badge>
      </div>

      <!-- Impegno Details -->
      <div class="impegno-details">
        <div class="detail-icon">
          <ion-icon [name]="getImpegnoIcon(nextImpegno)"></ion-icon>
        </div>
        
        <div class="detail-content">
          <h2 class="impegno-title">{{ nextImpegno.DENOMINAZIONE }}</h2>
          
          <div class="detail-row">
            <ion-icon name="calendar"></ion-icon>
            <span>{{ nextImpegno.DATAORAINIZIO | date: 'EEEE dd MMMM' | titlecase }}</span>
          </div>

          <div class="detail-row">
            <ion-icon name="time"></ion-icon>
            <span>{{ nextImpegno.DATAORAINIZIO | date: 'HH:mm' }}</span>
            <span *ngIf="nextImpegno.DATAORAFINE" class="time-separator">→</span>
            <span *ngIf="nextImpegno.DATAORAFINE">{{ nextImpegno.DATAORAFINE | date: 'HH:mm' }}</span>
          </div>

          <div class="detail-row" *ngIf="nextImpegno['_DENOMINAZIONE_Location']">
            <ion-icon name="location"></ion-icon>
            <span>{{ nextImpegno['_DENOMINAZIONE_Location'] }}</span>
          </div>
        </div>
      </div>

      <!-- Quick Action -->
      <div class="card-action">
        <span>Visualizza dettagli</span>
        <ion-icon name="chevron-forward"></ion-icon>
      </div>
    </div>
  </div>

  <!-- TIMELINE IMPEGNI -->
  <div class="timeline-section" *ngIf="getFilteredImpegni().length > 0">
    <div class="section-header">
      <h3>
        <ion-icon name="list"></ion-icon>
        {{ getTimelineTitle() }}
      </h3>
      <span class="count-badge">{{ getFilteredImpegni().length }}</span>
    </div>

    <!-- Timeline List -->
<!-- Timeline List -->
<div class="timeline-list">
  <div 
    class="timeline-item"
    *ngFor="let impegno of getFilteredImpegni(); let i = index"
    [class.passed]="isPassedImpegno(impegno)"
    (click)="onClickImpegnoPersonale(impegno)">
    
    <!-- Timeline Dot -->
    <div class="timeline-dot-wrapper">
      <div class="timeline-line" *ngIf="i !== getFilteredImpegni().length - 1"></div>
        <div class="timeline-dot" [style.background]="getImpegnoColor(impegno)">
          <ion-icon [name]="getImpegnoIcon(impegno)"></ion-icon>
        </div>
        <!-- Date Badge -->
        <div class="date-badge">
          <!-- Formato compatto (desktop) -->
          <div class="date-day">{{ impegno.DATAORAINIZIO | date: 'dd' }}</div>
          <div class="date-month">{{ impegno.DATAORAINIZIO | date: 'MMM' | uppercase }}</div>
          
          <!-- Formato esteso (mobile) -->
          <div class="date-full">{{ impegno.DATAORAINIZIO | date: 'EEEE d MMMM yyyy' | titlecase }}</div>
        </div>
    </div>

    <!-- Timeline Content -->
    <div class="timeline-content">

      <!-- Impegno Card -->
      <div class="timeline-card">
        <div class="card-header">
          <h4>{{ impegno.DENOMINAZIONE }}</h4>
          <ion-badge [color]="getImpegnoColor(impegno)" class="type-badge">
            {{ getCampoImpegno(impegno) }}
          </ion-badge>
        </div>

        <div class="card-details">
          <div class="detail-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ impegno.DATAORAINIZIO | date: 'HH:mm' }}</span>
            <span *ngIf="impegno.DATAORAFINE" class="separator">-</span>
            <span *ngIf="impegno.DATAORAFINE">{{ impegno.DATAORAFINE | date: 'HH:mm' }}</span>
          </div>

          <div class="detail-item" *ngIf="impegno['_DENOMINAZIONE_Location']">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ impegno['_DENOMINAZIONE_Location'] }}</span>
          </div>

          <!-- Multi-day indicator -->
          <div class="detail-item multi-day" *ngIf="!impegno.compareEqualDate()">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>Fino a {{ impegno.DATAORAFINE | date: 'dd/MM/yyyy' }}</span>
          </div>
        </div>

        <!-- Status indicator -->
        <div class="card-status" [class.passed]="isPassedImpegno(impegno)">
          <ion-icon [name]="isPassedImpegno(impegno) ? 'checkmark-circle' : 'time'"></ion-icon>
          <span>{{ isPassedImpegno(impegno) ? 'Completato' : 'Programmato' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- INFINITE SCROLL -->
    <ion-infinite-scroll
      *ngIf="numRequestImpegniTop != 0"
      threshold="100px"
      (ionInfinite)="onActivateInfiniteScrollImpegni($event)">
      <ion-infinite-scroll-content 
        loading-spinner="circles" 
        loadingText="Caricamento...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </div>

  <!-- EMPTY STATE -->
  <div class="empty-state" *ngIf="!listImpegni || listImpegni.length === 0">
    <div class="empty-icon">
      <ion-icon name="calendar-clear-outline"></ion-icon>
    </div>
    <h3>Nessun impegno in programma</h3>
    <p>La tua agenda è vuota. Prenota un campo o iscriviti a un corso!</p>
    
    <div class="empty-actions">
      <ion-button fill="solid" color="success" (click)="onNavigateToBooking()">
        <ion-icon name="add-circle" slot="start"></ion-icon>
        Prenota Campo
      </ion-button>
      <ion-button fill="outline" (click)="onNavigateToCourses()">
        <ion-icon name="school" slot="start"></ion-icon>
        Vedi Corsi
      </ion-button>
    </div>
  </div>

  <!-- SKELETON LOADER -->
  <div class="skeleton-loader" *ngIf="isLoadingPersonal">
    <div class="skeleton-stat-row">
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
    </div>

    <ion-skeleton-text animated style="width: 100%; height: 200px; border-radius: 20px; margin: 20px 0;"></ion-skeleton-text>

    <div class="skeleton-timeline">
      <ion-skeleton-text animated style="width: 100%; height: 120px; border-radius: 16px; margin-bottom: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 120px; border-radius: 16px; margin-bottom: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 120px; border-radius: 16px;"></ion-skeleton-text>
    </div>
  </div>

</div>

<!-- SEGMENTO TRAINER -->
<div *ngIf="selectedView == 'trainer'" class="trainer-view">

  <!-- QUICK STATS ROW -->
  <div class="stats-row">
    <div class="stat-card">
      <ion-icon name="today-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ getLezioniOggi() }}</span>
        <span class="stat-label">Oggi</span>
      </div>
    </div>

    <div class="stat-card">
      <ion-icon name="time-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ getProssimaLezioneTime() }}</span>
        <span class="stat-label">Prossima</span>
      </div>
    </div>

    <div class="stat-card active">
      <ion-icon name="people-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ getTotalPartecipanti() }}</span>
        <span class="stat-label">Partecipanti</span>
      </div>
    </div>
  </div>

  <!-- QUICK ACTIONS -->
  <div class="quick-actions">
    <div class="action-card primary" (click)="onClickGoToListaValutazioniTrainer()">
      <div class="action-icon">
        <ion-icon name="star"></ion-icon>
      </div>
      <div class="action-content">
        <h4>Valutazioni</h4>
        <p>Fine corsi</p>
      </div>
      <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
    </div>

  </div>

  <!-- FILTRI PERIODO -->
  <div class="period-filters">
    <div class="filter-chips">
      <ion-chip 
        *ngFor="let item of searchListPeriodi"
        [class.active]="item.value === searchTrainerPeriodo"
        (click)="onChangePeriodoTrainer(item.value)">
        <ion-icon [name]="getPeriodIcon(item.value)"></ion-icon>
        <ion-label>{{ item.title }}</ion-label>
      </ion-chip>
    </div>


    <!-- DATE PICKER CARD -->
    <div class="date-picker-card" (click)="openDatePicker()">
      <div class="date-display">
        <ion-icon name="calendar-outline" color="primary"></ion-icon>
        <div class="date-info">
          <span class="date-label">{{ searchTrainerDateLabel }}</span>
          <span class="date-value">{{ searchTrainerDate | date: getDateFormat() }}</span>
        </div>
      </div>
      <ion-icon name="chevron-down" class="expand-icon"></ion-icon>
    </div>

    <!-- Hidden date picker - INVISIBILE ma PRESENTE -->
    <div class="hidden-dtinput">
      <app-dtinput
        textAlignmentRight="true"
        title="Filtro"
        [label]="searchTrainerDateLabel"
        itemColor="light"
        itemLines="none"
        iconName="calendar-outline"
        iconColor="primary"
        maskFormat="dddd dd/MM/yyyy"
        [calendarMode]="searchTrainerCalendarMode"
        [(actualDate)]="searchTrainerDate"
        (actualDateChange)="onChangeDataPeriodoTrainer()">
      </app-dtinput>
    </div>
  </div>

  <!-- LISTA IMPEGNI TRAINER -->
  <div class="impegni-section" *ngIf="listImpegniTrainer && listImpegniTrainer.length > 0">
    <div class="section-header">
      <h3>
        <ion-icon name="clipboard"></ion-icon>
        {{ getTrainerSectionTitle() }}
      </h3>
      <span class="count-badge">{{ listImpegniTrainer.length }}</span>
    </div>

    <!-- Timeline List -->

<!-- Timeline List TRAINER -->
<div class="timeline-list">
  <div 
    class="timeline-item"
    *ngFor="let impegno of listImpegniTrainer; let i = index"
    [class.passed]="isPassedImpegnoTrainer(impegno)"
    (click)="onClickImpegnoTrainer(impegno)">
    
    <!-- Timeline Dot -->
    <div class="timeline-dot-wrapper">
      <div class="timeline-line" *ngIf="i !== listImpegniTrainer.length - 1"></div>
      <div class="timeline-dot" [style.background]="getImpegnoTrainerColor(impegno)">
        <ion-icon [name]="getImpegnoTrainerIcon(impegno)"></ion-icon>
      </div>

      <!-- Date Badge -->
      <div class="date-badge">
        <!-- Formato compatto (desktop) -->
        <div class="date-day">{{ impegno.DATAORAINIZIO | date: 'dd' }}</div>
        <div class="date-month">{{ impegno.DATAORAINIZIO | date: 'MMM' | uppercase }}</div>
        
        <!-- Formato esteso (mobile) -->
        <div class="date-full">{{ impegno.DATAORAINIZIO | date: 'EEEE d MMMM yyyy' | titlecase }}</div>
      </div>
    </div>

    <!-- Timeline Content -->
    <div class="timeline-content">

      <!-- Impegno Card -->
      <div class="timeline-card trainer-card">
        <div class="card-header">
          <h4>{{ impegno.DENOMINAZIONE }}</h4>
          <ion-badge [color]="getImpegnoTrainerColor(impegno)" class="type-badge">
            {{ getImpegnoTrainerType(impegno) }}
          </ion-badge>
        </div>

        <div class="card-details">
          <div class="detail-item">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ impegno.DATAORAINIZIO | date: 'HH:mm' }}</span>
            <span *ngIf="impegno.DATAORAFINE && impegno.compareEqualDate()" class="separator">-</span>
            <span *ngIf="impegno.DATAORAFINE && impegno.compareEqualDate()">{{ impegno.DATAORAFINE | date: 'HH:mm' }}</span>
          </div>

          <div class="detail-item" *ngIf="impegno.DENOMINAZIONELOCATION">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ impegno.DENOMINAZIONELOCATION }}</span>
          </div>

          <div class="detail-item" *ngIf="impegno.DENOMINAZIONESPORT">
            <ion-icon name="basketball-outline"></ion-icon>
            <span>{{ impegno.DENOMINAZIONESPORT }}</span>
          </div>

          <!-- Multi-day indicator -->
          <div class="detail-item multi-day" *ngIf="!impegno.compareEqualDate()">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>Fino a {{ impegno.DATAORAFINE | date: 'dd/MM/yyyy' }}</span>
          </div>
        </div>

        <!-- Trainer specific actions -->
        <div class="card-actions">
          <ion-button 
            size="small" 
            fill="outline" 
            color="success"
            (click)="onGestionePresenze($event, impegno)">
            <ion-icon name="checkmark-done" slot="start"></ion-icon>
            Presenze
          </ion-button>

          <div class="card-status" [class.passed]="isPassedImpegnoTrainer(impegno)">
            <ion-icon [name]="isPassedImpegnoTrainer(impegno) ? 'checkmark-circle' : 'time'"></ion-icon>
            <span>{{ isPassedImpegnoTrainer(impegno) ? 'Completato' : 'Programmato' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- INFINITE SCROLL -->
    <ion-infinite-scroll
      *ngIf="numRequestImpegniTrainerTop != 0"
      threshold="100px"
      (ionInfinite)="onActivateInfiniteScrollImpegniTrainer($event)">
      <ion-infinite-scroll-content 
        loading-spinner="circles" 
        loadingText="Caricamento...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </div>

  <!-- EMPTY STATE -->
  <div class="empty-state" *ngIf="!listImpegniTrainer || listImpegniTrainer.length === 0">
    <div class="empty-icon">
      <ion-icon name="clipboard-outline"></ion-icon>
    </div>
    <h3>Nessuna lezione in programma</h3>
    <p>Non ci sono impegni da trainer per il periodo selezionato</p>
    
    <div class="empty-actions">
      <ion-button fill="outline" (click)="onClickGoToListaValutazioniTrainer()">
        <ion-icon name="star" slot="start"></ion-icon>
        Valutazioni
      </ion-button>
    </div>
  </div>

  <!-- SKELETON LOADER -->
  <div class="skeleton-loader" *ngIf="isLoadingTrainer">
    <div class="skeleton-stat-row">
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
    </div>

    <div class="skeleton-actions">
      <ion-skeleton-text animated style="width: 100%; height: 100px; border-radius: 16px; margin-bottom: 12px;"></ion-skeleton-text>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <ion-skeleton-text animated style="width: 100%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 100%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
      </div>
    </div>

    <div class="skeleton-timeline">
      <ion-skeleton-text animated style="width: 100%; height: 140px; border-radius: 16px; margin-bottom: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 140px; border-radius: 16px; margin-bottom: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 140px; border-radius: 16px;"></ion-skeleton-text>
    </div>
  </div>

</div>

<!-- SEGMENTO CUSTODE -->
<div *ngIf="selectedView == 'custode'" class="custode-view">

  <!-- QUICK STATS ROW -->
  <div class="stats-row">
    <div class="stat-card">
      <ion-icon name="today-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ getOccupazioniOggi() }}</span>
        <span class="stat-label">Oggi</span>
      </div>
    </div>

    <div class="stat-card">
      <ion-icon name="location-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ getLocationAttive() }}</span>
        <span class="stat-label">Location</span>
      </div>
    </div>

    <div class="stat-card active">
      <ion-icon name="calendar-outline" class="stat-icon"></ion-icon>
      <div class="stat-content">
        <span class="stat-value">{{ listImpegniCustode?.length || 0 }}</span>
        <span class="stat-label">Totale</span>
      </div>
    </div>
  </div>

  <!-- QUICK ACTIONS -->
  <div class="quick-actions">
    <!-- Scansiona QR -->
    <div 
      *ngIf="!platformDesktop"
      class="action-card primary" 
      (click)="onClickQrCodeCustode()">
      <div class="action-icon">
        <ion-icon name="qr-code"></ion-icon>
      </div>
      <div class="action-content">
        <h4>Scansiona Codice</h4>
        <p>QR Code utente o prenotazione</p>
      </div>
      <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
    </div>

    <!-- Clienti -->
    <div class="action-card secondary" (click)="goToListCustomer()">
      <div class="action-icon">
        <ion-icon name="people"></ion-icon>
      </div>
      <div class="action-content">
        <h4>Clienti</h4>
        <p>Gestisci anagrafica</p>
      </div>
      <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
    </div>
  </div>

  <!-- FILTRI PERIODO -->
  <div class="period-filters">
    <div class="filter-chips">
      <ion-chip 
        *ngFor="let item of searchListPeriodi"
        [class.active]="item.value === searchCustodePeriodo"
        (click)="onChangePeriodoCustode(item.value)">
        <ion-icon [name]="getPeriodIcon(item.value)"></ion-icon>
        <ion-label>{{ item.title }}</ion-label>
      </ion-chip>
    </div>

    <!-- DATE PICKER CARD -->
    <div class="date-picker-card" (click)="openDatePickerCustode()">
      <div class="date-display">
        <ion-icon name="calendar-outline" color="primary"></ion-icon>
        <div class="date-info">
          <span class="date-label">{{ searchCustodeDateLabel }}</span>
          <span class="date-value">{{ searchCustodeDate | date: getDateFormatCustode() }}</span>
        </div>
      </div>
      <ion-icon name="chevron-down" class="expand-icon"></ion-icon>
    </div>

    <!-- Hidden date picker -->
    <div class="hidden-dtinput">
      <app-dtinput
        textAlignmentRight="true"
        title="Filtro"
        [label]="searchCustodeDateLabel"
        itemColor="light"
        itemLines="none"
        iconName="calendar-outline"
        iconColor="primary"
        maskFormat="dddd dd/MM/yyyy"
        [calendarMode]="searchCustodeCalendarMode"
        [(actualDate)]="searchCustodeDate"
        (actualDateChange)="onChangeDataPeriodoCustode()">
      </app-dtinput>
    </div>

    <!-- LOCATION FILTER CARD (solo se più di 2 location) -->
    <div 
      *ngIf="listLocation && listLocation.length > 2"
      class="location-filter-card"
      (click)="toggleLocationFilter()">
      <div class="location-display">
        <ion-icon name="location" color="success"></ion-icon>
        <div class="location-info">
          <span class="location-label">Location</span>
          <span class="location-value">{{ selectedLocation?.DENOMINAZIONE || 'Tutte' }}</span>
        </div>
      </div>
      <ion-icon 
        name="chevron-down" 
        class="expand-icon"
        [class.expanded]="showLocationFilter"></ion-icon>
    </div>

    <!-- Location options (espandibile) -->
    <div 
      *ngIf="showLocationFilter && listLocation && listLocation.length > 2"
      class="location-options"
      [@slideDown]>
      <div 
        class="location-option"
        *ngFor="let itemLocation of listLocation"
        [class.active]="itemLocation.ID === idSelectedLocation"
        (click)="onChangeLocationCustode(itemLocation.ID)">
        <ion-icon 
          [name]="itemLocation.ID === idSelectedLocation ? 'radio-button-on' : 'radio-button-off'"
          [color]="itemLocation.ID === idSelectedLocation ? 'success' : 'medium'"></ion-icon>
        <span>{{ itemLocation.DENOMINAZIONE }}</span>
      </div>
    </div>
  </div>

  <!-- LISTA IMPEGNI CUSTODE -->
  <div class="impegni-section" *ngIf="listImpegniCustode && listImpegniCustode.length > 0">
    <div class="section-header">
      <h3>
        <ion-icon name="clipboard"></ion-icon>
        {{ getCustodeSectionTitle() }}
      </h3>
      <span class="count-badge">{{ listImpegniCustode.length }}</span>
    </div>

    <!-- Lista Impegni Custode -->
    <div class="custode-timeline-list">
      <app-impegni-custodi
        [impegnoDoc]="item"
        (OnClickItem)="onClickImpegnoCustode(item)" 
        *ngFor="let item of listImpegniCustode">
      </app-impegni-custodi>
    </div>

    <!-- INFINITE SCROLL -->
    <ion-infinite-scroll
      *ngIf="numRequestImpegniCustodeTop != 0"
      threshold="100px"
      (ionInfinite)="onActivateInfiniteScrollImpegniCustode($event)">
      <ion-infinite-scroll-content 
        loading-spinner="circles" 
        loadingText="Caricamento...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </div>

  <!-- EMPTY STATE -->
  <div class="empty-state" *ngIf="!listImpegniCustode || listImpegniCustode.length === 0">
    <div class="empty-icon">
      <ion-icon name="calendar-clear-outline"></ion-icon>
    </div>
    <h3>Nessuna occupazione</h3>
    <p>Non ci sono impegni per il periodo e la location selezionati</p>
    
    <div class="empty-actions">
      <ion-button 
        *ngIf="!platformDesktop"
        fill="solid" 
        color="success" 
        (click)="onClickQrCodeCustode()">
        <ion-icon name="qr-code" slot="start"></ion-icon>
        Scansiona Codice
      </ion-button>
      <ion-button fill="outline" (click)="goToListCustomer()">
        <ion-icon name="people" slot="start"></ion-icon>
        Gestisci Clienti
      </ion-button>
    </div>
  </div>

  <!-- SKELETON LOADER -->
  <div class="skeleton-loader" *ngIf="isLoadingCustode">
    <div class="skeleton-stat-row">
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 30%; height: 80px; border-radius: 16px;"></ion-skeleton-text>
    </div>

    <div class="skeleton-actions">
      <ion-skeleton-text animated style="width: 100%; height: 100px; border-radius: 16px; margin-bottom: 12px;"></ion-skeleton-text>
    </div>

    <div class="skeleton-timeline">
      <ion-skeleton-text animated style="width: 100%; height: 120px; border-radius: 16px; margin-bottom: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 120px; border-radius: 16px; margin-bottom: 16px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 120px; border-radius: 16px;"></ion-skeleton-text>
    </div>
  </div>

</div>
      </ion-col>  
    </ion-row>  
  </ion-grid>                
</ion-content>
